var dim={defaultPort:2511,defaultHost:"localhost",websockets:{browser:{getServices:"dqmnet/browser/getServices",getServers:"dqmnet/browser/getServers",getServerServices:"dqmnet/browser/getServerServices",getServerClients:"dqmnet/browser/getServerClients"},command:"dqmnet/command",rpc:"dqmnet/rpc",service:"dqmnet/service"},maxServiceName:132,maxNumberStrLen:16,errorCodes:{serviceNameTooLong:1,invalidUserData:2,noHandlerRegistered:3,websocketNotReady:4}};dim.createWebSocket=function(e,s){return new ReconnectingWebSocket("ws://"+e.host+":"+e.port+"/"+s)},dim.UID=function(){var e=0,s=[];this.getUID=function(){return s.length>0?s.shift():e++},this.reUse=function(r){r<0||e<=r||"number"!=typeof r||s.indexOf(r)>=0||s.push(r)}},dim.guid=new dim.UID,dim.DimClient=function(e,s){var r=this;this.host=void 0===e?dim.defaultHost:e,this.port=void 0===s?dim.defaultPort:s,this.errorHandler=null,this.onconnect=null,this.ondisconnect=null,this.websockets=[],this.commandWs=null,this.rpcWs=null,this.serviceWs=null,this.getServicesWs=null,this.getServersWs=null,this.getServerServicesWs=null,this.getServerClientsWs=null,this.uniqueHandlers={},this.serviceHandlers={};var t=dim.guid,i=function(e){for(var s=0,t=0;t<r.websockets.length;t++)1==r.websockets[t].readyState&&s++;console.log("open counter = "+s.toString()),s==r.websockets.length&&null!=r.onconnect&&r.onconnect()},n=function(e){for(var s=0,t=0;t<r.websockets.length;t++)3==r.websockets[t].readyState&&s++;s==r.websockets.length&&null!=r.ondisconnect&&r.ondisconnect()},o=function(e){var s=e.data,i=s.substr(0,dim.maxNumberStrLen).trim(),n=s.substr(dim.maxNumberStrLen),o=r.uniqueHandlers[i];void 0!==o&&(o(n),delete r.uniqueHandlers[i]),t.reUse(Number(i))};this.createWebSocket=function(e,s){return e&&e.close(),e=null,dim.createWebSocket(this,s)},this.createWebSockets=function(){this.commandWs=this.createWebSocket(this.commandWs,dim.websockets.command),this.rpcWs=this.createWebSocket(this.rpcWs,dim.websockets.rpc),this.serviceWs=this.createWebSocket(this.serviceWs,dim.websockets.service),this.getServicesWs=this.createWebSocket(this.getServicesWs,dim.websockets.browser.getServices),this.getServersWs=this.createWebSocket(this.getServersWs,dim.websockets.browser.getServers),this.getServerServicesWs=this.createWebSocket(this.getServerServicesWs,dim.websockets.browser.getServerServices),this.getServerClientsWs=this.createWebSocket(this.getServerClientsWs,dim.websockets.browser.getServerClients),this.websockets=[this.commandWs,this.rpcWs,this.serviceWs,this.getServicesWs,this.getServersWs,this.getServerServicesWs,this.getServerClientsWs],this.commandWs.onopen=i,this.rpcWs.onopen=i,this.getServicesWs.onopen=i,this.getServersWs.onopen=i,this.getServerServicesWs.onopen=i,this.getServerClientsWs.onopen=i,this.commandWs.onclose=n,this.rpcWs.onclose=n,this.serviceWs.onclose=n,this.getServicesWs.onclose=n,this.getServersWs.onclose=n,this.getServerServicesWs.onclose=n,this.getServerClientsWs.onclose=n,this.rpcWs.onmessage=o,this.getServicesWs.onmessage=o,this.getServersWs.onmessage=o,this.getServerServicesWs.onmessage=o,this.getServerClientsWs.onmessage=o,this.serviceWs.onmessage=function(e){var s=e.data,t=s.substr(0,dim.maxServiceName).trim(),i=s.substr(dim.maxServiceName),n=r.serviceHandlers[t];if(void 0!==n)for(var o=0;o<n.length;o++)n[o](i)},this.serviceWs.onopen=function(e){i()}};this.websocketsReady=function(){for(var e=0;e<this.websockets.length;e++)if(1!=this.websockets[e].readyState)return!1;return!0},this.printWsStatus=function(){for(var e=0;e<this.websockets.length;e++)console.log(this.websockets[e].readyState)},this.sendCommand=function(e,s){if(e.length>=dim.maxServiceName&&null!==this.errorHandler)this.errorHandler(dim.errorCodes.serviceNameTooLong);else if(1==this.commandWs.readyState||null===this.errorHandler){var r=e;if(r+=" ".repeat(dim.maxServiceName-e.length),"string"==typeof s)r+=s;else if("function"==typeof s.toString)r+=s.toString();else if("object"==typeof s)r+=JSON.stringify(s);else if(null!==this.errorHandler)return void this.errorHandler(dim.errorCodes.invalidUserData);this.commandWs.send(r)}else this.errorHandler(dim.errorCodes.websocketNotReady)},this.sendRequest=function(e,s,r){if(e.length>=dim.maxServiceName&&null!==this.errorHandler)this.errorHandler(dim.errorCodes.serviceNameTooLong);else{var i=e;i+=" ".repeat(dim.maxServiceName-e.length);var n=t.getUID().toString();if(i+=n,i+=" ".repeat(dim.maxNumberStrLen-n.length),"string"==typeof s)i+=s;else if("function"===s.toString)i+=s.toString();else if("object"==typeof s)i+=JSON.stringify(s);else if(null!==this.errorHandler)return void this.errorHandler(dim.errorCodes.invalidUserData);this.uniqueHandlers[n]=r,this.rpcWs.send(i)}},this.subscribe=function(e,s){if(e.length>=dim.maxServiceName&&null!==this.errorHandler)return console.log("Error caught from subscribe"),void this.errorHandler(dim.errorCodes.serviceNameTooLong);var r=e;r+=" ".repeat(dim.maxServiceName-e.length),r+="subscribe",this.addServiceHandler(e,s),this.serviceWs.send(r)},this.unsubscribe=function(e,s){if(e.length>=dim.maxServiceName&&null!==this.errorHandler)return console.log("Error caught from unsubscribe"),void this.errorHandler(dim.errorCodes.serviceNameTooLong);var r=e;r+=" ".repeat(dim.maxServiceName-e.length),r+="unsubscribe",this.removeServiceHandler(e,s),this.serviceWs.send(r)},this.getServices=function(e,s){var r=t.getUID().toString(),i=r;i+=" ".repeat(dim.maxNumberStrLen-r.length),i+=e,this.uniqueHandlers[r]=function(e){var r=JSON.parse(e).services;s(r)},this.getServicesWs.send(i)},this.getServers=function(e){var s=t.getUID().toString(),r=s;r+=" ".repeat(dim.maxNumberStrLen-s.length),this.uniqueHandlers[s]=function(s){var r=JSON.parse(s).servers;e(r)},this.getServersWs.send(r)},this.getServerServices=function(e,s){var r=t.getUID().toString(),i=r;i+=" ".repeat(dim.maxNumberStrLen-r.length),i+=e,this.uniqueHandlers[r]=function(e){var r=JSON.parse(e).serverServices;s(r)},this.getServerServicesWs.send(i)},this.getServerClients=function(e,s){var r=t.getUID().toString(),i=r;i+=" ".repeat(dim.maxNumberStrLen-r.length),i+=e,this.uniqueHandlers[r]=function(e){var r=JSON.parse(e).serverClients;s(r)},this.getServerClientsWs.send(i)},this.createWebSockets()};
